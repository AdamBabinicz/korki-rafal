import {
  pgTable,
  text,
  serial,
  integer,
  boolean,
  timestamp,
  jsonb,
} from "drizzle-orm/pg-core";
import { createInsertSchema } from "drizzle-zod";
import { z } from "zod";

export const users = pgTable("users", {
  id: serial("id").primaryKey(),
  username: text("username").notNull().unique(),
  email: text("email"),
  password: text("password").notNull(),
  role: text("role").notNull().default("student"),
  name: text("name").notNull(),
  phone: text("phone"),
  address: text("address"),
  adminNotes: text("admin_notes"),
  defaultPrice: integer("default_price"),
});

export const slots = pgTable("slots", {
  id: serial("id").primaryKey(),
  startTime: timestamp("start_time").notNull(),
  endTime: timestamp("end_time").notNull(),
  isBooked: boolean("is_booked").default(false).notNull(),
  studentId: integer("student_id").references(() => users.id),
  isPaid: boolean("is_paid").default(false).notNull(),
  topic: text("topic"),
  notes: text("notes"),
  price: integer("price"),
  adminNotes: text("admin_notes"),
});

export const weeklySchedule = pgTable("weekly_schedule", {
  id: serial("id").primaryKey(),
  dayOfWeek: integer("day_of_week").notNull(),
  startTime: text("start_time").notNull(),
  durationMinutes: integer("duration_minutes").notNull(),
  studentId: integer("student_id").references(() => users.id),
  price: integer("price").notNull().default(0),
});

export const waitlist = pgTable("waitlist", {
  id: serial("id").primaryKey(),
  date: timestamp("date").notNull(),
  userId: integer("user_id")
    .references(() => users.id)
    .notNull(),
});

export const sessions = pgTable("session", {
  sid: text("sid").primaryKey(),
  sess: jsonb("sess").notNull(),
  expire: timestamp("expire", { precision: 6 }).notNull(),
});

export const insertUserSchema = createInsertSchema(users)
  .pick({
    username: true,
    password: true,
    role: true,
    name: true,
    phone: true,
    address: true,
    adminNotes: true,
    defaultPrice: true,
  })
  .extend({
    email: z.string().email().optional().or(z.literal("")),
  });

export const insertSlotSchema = createInsertSchema(slots).omit({
  id: true,
});

export const insertWeeklyScheduleSchema = createInsertSchema(
  weeklySchedule
).omit({
  id: true,
});

export const insertWaitlistSchema = createInsertSchema(waitlist).omit({
  id: true,
});

export const generateSlotsSchema = z.object({
  startDate: z.string(),
  endDate: z.string(),
  startTime: z.string(),
  endTime: z.string(),
  duration: z.number(),
});

export const generateFromTemplateSchema = z.object({
  startDate: z.string(),
  endDate: z.string(),
});

export type User = typeof users.$inferSelect;
export type InsertUser = z.infer<typeof insertUserSchema>;
export type Slot = typeof slots.$inferSelect;
export type InsertSlot = z.infer<typeof insertSlotSchema>;
export type WeeklySchedule = typeof weeklySchedule.$inferSelect;
export type InsertWeeklySchedule = z.infer<typeof insertWeeklyScheduleSchema>;
export type Waitlist = typeof waitlist.$inferSelect;
export type InsertWaitlist = z.infer<typeof insertWaitlistSchema>;
---------------------------------------------------------
import { useState } from "react";
import {
  useSlots,
  useGenerateSlotsFromTemplate,
  useDeleteSlot,
  useUpdateSlot,
} from "@/hooks/use-slots";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { apiRequest } from "@/lib/queryClient";
import { useToast } from "@/hooks/use-toast";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import {
  format,
  startOfWeek,
  endOfWeek,
  addDays,
  eachDayOfInterval,
  addWeeks,
  subWeeks,
} from "date-fns";
import { pl, enUS } from "date-fns/locale";
import {
  Loader2,
  Plus,
  Trash2,
  CheckCircle,
  Ban,
  ChevronLeft,
  ChevronRight,
  User,
  Phone,
  MapPin,
  Calendar as CalendarIcon,
  Copy,
  Users,
} from "lucide-react";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogTrigger,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Label } from "@/components/ui/label";
import { useTranslation } from "react-i18next";
import { WeeklySchedule, User as UserType } from "@shared/schema";

export default function AdminPanel() {
  const { t, i18n } = useTranslation();
  const [selectedDate, setSelectedDate] = useState(new Date());
  const { data: slots, isLoading: loadingSlots } = useSlots();
  const { mutate: deleteSlot } = useDeleteSlot();
  const { mutate: updateSlot } = useUpdateSlot();
  const { mutate: generateFromTemplate, isPending: isGenerating } =
    useGenerateSlotsFromTemplate();
  const { toast } = useToast();
  const queryClient = useQueryClient();

  // Pobieranie uczni√≥w
  const { data: students, isLoading: loadingStudents } = useQuery<UserType[]>({
    queryKey: ["/api/users"],
  });

  // Pobieranie szablonu tygodniowego
  const { data: weeklySchedule, isLoading: loadingSchedule } = useQuery<
    (WeeklySchedule & { student?: UserType | null })[]
  >({
    queryKey: ["/api/weekly-schedule"],
  });

  // Mutacja dodawania elementu do szablonu
  const addToScheduleMutation = useMutation({
    mutationFn: async (newItem: any) => {
      await apiRequest("POST", "/api/weekly-schedule", newItem);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/weekly-schedule"] });
      toast({ title: t("admin.template_added") });
    },
  });

  // Mutacja usuwania elementu z szablonu
  const deleteFromScheduleMutation = useMutation({
    mutationFn: async (id: number) => {
      await apiRequest("DELETE", `/api/weekly-schedule/${id}`);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/weekly-schedule"] });
      toast({ title: t("admin.template_removed") });
    },
  });

  // Mutacja: Usuwanie ucznia
  const deleteUserMutation = useMutation({
    mutationFn: async (id: number) => {
      await apiRequest("DELETE", `/api/users/${id}`);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/users"] });
      toast({ title: "U≈ºytkownik usuniƒôty" });
    },
  });

  // Mutacja: Dodawanie ucznia
  const [newStudent, setNewStudent] = useState({
    name: "",
    username: "",
    password: "",
    email: "",
    phone: "",
    address: "",
  });
  const [isAddStudentOpen, setIsAddStudentOpen] = useState(false);

  const createUserMutation = useMutation({
    mutationFn: async (userData: typeof newStudent) => {
      await apiRequest("POST", "/api/users", userData);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/users"] });
      toast({ title: "Ucze≈Ñ dodany pomy≈õlnie" });
      setIsAddStudentOpen(false);
      setNewStudent({
        name: "",
        username: "",
        password: "",
        email: "",
        phone: "",
        address: "",
      });
    },
    onError: (err: any) => {
      toast({
        variant: "destructive",
        title: "B≈ÇƒÖd",
        description: err.message || "Nie uda≈Ço siƒô dodaƒá ucznia",
      });
    },
  });

  const handleAddStudent = () => {
    createUserMutation.mutate(newStudent);
  };

  const locale = i18n.language === "pl" ? pl : enUS;

  const [generateForm, setGenerateForm] = useState({
    startDate: format(new Date(), "yyyy-MM-dd"),
    endDate: format(addDays(new Date(), 30), "yyyy-MM-dd"),
  });

  const [newTemplateItem, setNewTemplateItem] = useState({
    dayOfWeek: "1", // Poniedzia≈Çek
    startTime: "16:00",
    durationMinutes: 60,
    price: 80,
    studentId: "none",
  });

  const handleGenerate = () => {
    generateFromTemplate(generateForm, {
      onSuccess: (data: any) => {
        toast({
          title: t("booking.success"),
          description: data.message,
        });
        queryClient.invalidateQueries({ queryKey: ["/api/slots"] });
      },
      onError: (err) => {
        toast({
          variant: "destructive",
          title: "B≈ÇƒÖd",
          description: err.message,
        });
      },
    });
  };

  const handleAddToTemplate = () => {
    addToScheduleMutation.mutate({
      ...newTemplateItem,
      dayOfWeek: parseInt(newTemplateItem.dayOfWeek),
      studentId:
        newTemplateItem.studentId === "none"
          ? null
          : parseInt(newTemplateItem.studentId),
    });
  };

  const weekStart = startOfWeek(selectedDate, { weekStartsOn: 1 });
  const weekEnd = endOfWeek(selectedDate, { weekStartsOn: 1 });
  const weekDays = eachDayOfInterval({ start: weekStart, end: weekEnd });

  const dayMapping: Record<number, string> = {
    1: t("admin.days.1"),
    2: t("admin.days.2"),
    3: t("admin.days.3"),
    4: t("admin.days.4"),
    5: t("admin.days.5"),
    6: t("admin.days.6"),
    0: t("admin.days.0"),
  };

  if (loadingSlots || loadingSchedule || loadingStudents)
    return (
      <div className="min-h-screen grid place-items-center">
        <Loader2 className="animate-spin w-10 h-10 text-primary" />
      </div>
    );

  return (
    <div className="min-h-screen bg-background pt-24 pb-12 px-4">
      <div className="max-w-[1600px] mx-auto space-y-8">
        <div className="flex flex-col md:flex-row justify-between items-center gap-4">
          <div>
            <h1 className="text-3xl font-bold">{t("admin.title")}</h1>
            <p className="text-muted-foreground">{t("admin.subtitle")}</p>
          </div>
        </div>

        <Tabs defaultValue="calendar" className="w-full">
          <TabsList className="grid w-full md:w-[600px] grid-cols-3 mb-8">
            <TabsTrigger value="calendar">
              {t("admin.tab_calendar")}
            </TabsTrigger>
            <TabsTrigger value="template">
              {t("admin.tab_template")}
            </TabsTrigger>
            <TabsTrigger value="students">
              {t("admin.tab_students")}
            </TabsTrigger>
          </TabsList>

          {/* --- ZAK≈ÅADKA 1: KALENDARZ (GRAFIK) --- */}
          <TabsContent value="calendar" className="space-y-6">
            <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-card p-4 rounded-xl border border-border shadow-sm">
              <div className="flex items-center gap-2">
                <Button
                  variant="outline"
                  size="icon"
                  onClick={() => setSelectedDate(subWeeks(selectedDate, 1))}
                >
                  <ChevronLeft className="w-5 h-5" />
                </Button>
                <span className="px-4 font-medium min-w-[180px] text-center capitalize text-lg">
                  {format(weekStart, "d MMM", { locale })} -{" "}
                  {format(weekEnd, "d MMM", { locale })}
                </span>
                <Button
                  variant="outline"
                  size="icon"
                  onClick={() => setSelectedDate(addWeeks(selectedDate, 1))}
                >
                  <ChevronRight className="w-5 h-5" />
                </Button>
              </div>

              <Dialog>
                <DialogTrigger asChild>
                  <Button className="gap-2 bg-primary text-primary-foreground hover:bg-primary/90 shadow-lg shadow-primary/20">
                    <Copy className="w-4 h-4" />{" "}
                    {t("admin.generate_from_template")}
                  </Button>
                </DialogTrigger>
                <DialogContent className="sm:max-w-md bg-card border-border">
                  <DialogHeader>
                    <DialogTitle>{t("admin.generate_title")}</DialogTitle>
                    <DialogDescription>
                      {t("admin.generate_desc")}
                    </DialogDescription>
                  </DialogHeader>
                  <div className="grid gap-4 py-4">
                    <div className="grid grid-cols-2 gap-4">
                      <div className="space-y-2">
                        <Label>{t("admin.start_date")}</Label>
                        <Input
                          type="date"
                          value={generateForm.startDate}
                          onChange={(e) =>
                            setGenerateForm({
                              ...generateForm,
                              startDate: e.target.value,
                            })
                          }
                        />
                      </div>
                      <div className="space-y-2">
                        <Label>{t("admin.end_date")}</Label>
                        <Input
                          type="date"
                          value={generateForm.endDate}
                          onChange={(e) =>
                            setGenerateForm({
                              ...generateForm,
                              endDate: e.target.value,
                            })
                          }
                        />
                      </div>
                    </div>
                    <Button onClick={handleGenerate} disabled={isGenerating}>
                      {isGenerating && (
                        <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                      )}
                      {t("admin.generate_submit")}
                    </Button>
                  </div>
                </DialogContent>
              </Dialog>
            </div>

            <div className="flex gap-4 overflow-x-auto pb-6 snap-x">
              {weekDays.map((day) => {
                const daySlots =
                  slots
                    ?.filter(
                      (s) =>
                        format(new Date(s.startTime), "yyyy-MM-dd") ===
                        format(day, "yyyy-MM-dd")
                    )
                    .sort(
                      (a, b) =>
                        new Date(a.startTime).getTime() -
                        new Date(b.startTime).getTime()
                    ) || [];

                return (
                  <div
                    key={day.toString()}
                    className="min-w-[280px] flex-shrink-0 snap-start"
                  >
                    <div className="text-center p-3 mb-3 bg-muted/30 rounded-xl border border-border sticky left-0 backdrop-blur-sm">
                      <div className="text-sm font-medium text-muted-foreground capitalize">
                        {format(day, "EEEE", { locale })}
                      </div>
                      <div className="text-xl font-bold text-foreground">
                        {format(day, "d MMM", { locale })}
                      </div>
                    </div>

                    <div className="space-y-3">
                      {daySlots.map((slot: any) => (
                        <Card
                          key={slot.id}
                          className={`p-3 relative group transition-all shadow-sm border-l-4 ${
                            slot.isBooked
                              ? slot.isPaid
                                ? "border-l-green-500 bg-card"
                                : "border-l-orange-500 bg-card"
                              : "border-l-primary/30 bg-muted/10 border-dashed border-y-0 border-r-0"
                          }`}
                        >
                          <div className="flex justify-between items-start mb-2">
                            <span className="text-sm font-bold font-mono px-2 py-1 bg-muted rounded">
                              {format(new Date(slot.startTime), "HH:mm")}
                            </span>
                            <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-background/90 rounded-lg shadow-sm p-1 absolute top-2 right-2">
                              {slot.isBooked && (
                                <button
                                  onClick={() =>
                                    updateSlot({
                                      id: slot.id,
                                      updates: { isPaid: !slot.isPaid },
                                    })
                                  }
                                  title={
                                    slot.isPaid
                                      ? t("dashboard.unpaid")
                                      : t("dashboard.paid")
                                  }
                                  className={`${
                                    slot.isPaid
                                      ? "text-green-500"
                                      : "text-gray-400"
                                  } hover:scale-110 transition-transform p-1`}
                                >
                                  <CheckCircle size={16} />
                                </button>
                              )}
                              {slot.isBooked && (
                                <button
                                  onClick={() =>
                                    updateSlot({
                                      id: slot.id,
                                      updates: {
                                        isBooked: false,
                                        studentId: null,
                                        isPaid: false,
                                      },
                                    })
                                  }
                                  title="Anuluj rezerwacjƒô"
                                  className="text-orange-500 hover:text-orange-400 p-1"
                                >
                                  <Ban size={16} />
                                </button>
                              )}

                              <button
                                onClick={() => {
                                  if (confirm(t("admin.delete_confirm")))
                                    deleteSlot(slot.id);
                                }}
                                className="text-destructive hover:text-red-400 p-1"
                                title="Usu≈Ñ slot"
                              >
                                <Trash2 size={16} />
                              </button>
                            </div>
                          </div>

                          {slot.isBooked ? (
                            <div className="text-xs space-y-2 mt-2">
                              <div className="font-medium text-foreground flex items-center gap-2 border-b border-border/50 pb-2">
                                <User className="w-3.5 h-3.5 text-primary" />
                                <span className="truncate text-sm font-bold">
                                  {slot.student?.name || t("admin.booked")}
                                </span>
                              </div>

                              {slot.student && (
                                <div className="space-y-1.5 pt-1 text-muted-foreground">
                                  {slot.student.phone && (
                                    <div className="flex items-center gap-2">
                                      <Phone className="w-3 h-3 flex-shrink-0" />
                                      <span>{slot.student.phone}</span>
                                    </div>
                                  )}
                                  {slot.price > 0 && (
                                    <div className="flex items-center gap-2">
                                      <span className="font-mono text-foreground">
                                        {slot.price} PLN
                                      </span>
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                          ) : (
                            <div className="text-xs text-muted-foreground/70 font-medium py-2 text-center mt-2 flex items-center justify-center gap-1">
                              <CheckCircle className="w-3 h-3" />{" "}
                              {t("admin.available")}
                            </div>
                          )}
                        </Card>
                      ))}
                      {daySlots.length === 0 && (
                        <div className="text-center py-12 text-sm text-muted-foreground border-2 border-dashed border-border/50 rounded-xl opacity-50">
                          {t("admin.no_slots")}
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </TabsContent>

          {/* --- ZAK≈ÅADKA 2: SZABLON (WEEKLY SCHEDULE) --- */}
          <TabsContent value="template" className="space-y-8">
            <Card className="border-secondary/20 shadow-md">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <CalendarIcon className="w-5 h-5 text-primary" />
                  {t("admin.template_title")}
                </CardTitle>
                <p className="text-sm text-muted-foreground">
                  {t("admin.template_desc")}
                </p>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-6 gap-4 items-end mb-8 bg-muted/30 p-4 rounded-xl border border-border">
                  <div className="space-y-2 md:col-span-1">
                    <Label>{t("admin.day")}</Label>
                    <Select
                      value={newTemplateItem.dayOfWeek}
                      onValueChange={(val) =>
                        setNewTemplateItem({
                          ...newTemplateItem,
                          dayOfWeek: val,
                        })
                      }
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="1">{dayMapping[1]}</SelectItem>
                        <SelectItem value="2">{dayMapping[2]}</SelectItem>
                        <SelectItem value="3">{dayMapping[3]}</SelectItem>
                        <SelectItem value="4">{dayMapping[4]}</SelectItem>
                        <SelectItem value="5">{dayMapping[5]}</SelectItem>
                        <SelectItem value="6">{dayMapping[6]}</SelectItem>
                        <SelectItem value="0">{dayMapping[0]}</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="space-y-2 md:col-span-1">
                    <Label>{t("admin.hour")}</Label>
                    <Input
                      type="time"
                      value={newTemplateItem.startTime}
                      onChange={(e) =>
                        setNewTemplateItem({
                          ...newTemplateItem,
                          startTime: e.target.value,
                        })
                      }
                    />
                  </div>
                  <div className="space-y-2 md:col-span-1">
                    <Label>{t("admin.time")}</Label>
                    <Input
                      type="number"
                      value={newTemplateItem.durationMinutes}
                      onChange={(e) =>
                        setNewTemplateItem({
                          ...newTemplateItem,
                          durationMinutes: parseInt(e.target.value),
                        })
                      }
                    />
                  </div>
                  <div className="space-y-2 md:col-span-1">
                    <Label>{t("admin.price")}</Label>
                    <Input
                      type="number"
                      value={newTemplateItem.price}
                      onChange={(e) =>
                        setNewTemplateItem({
                          ...newTemplateItem,
                          price: parseInt(e.target.value),
                        })
                      }
                    />
                  </div>
                  <div className="space-y-2 md:col-span-1">
                    <Label>{t("admin.student")}</Label>
                    <Select
                      value={newTemplateItem.studentId}
                      onValueChange={(val) =>
                        setNewTemplateItem({
                          ...newTemplateItem,
                          studentId: val,
                        })
                      }
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="Wybierz..." />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="none">
                          {t("admin.student_none")}
                        </SelectItem>
                        {students
                          ?.filter((s) => s.role === "student")
                          .map((s) => (
                            <SelectItem key={s.id} value={s.id.toString()}>
                              {s.name} ({s.username})
                            </SelectItem>
                          ))}
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="md:col-span-1">
                    <Button
                      onClick={handleAddToTemplate}
                      className="w-full bg-green-600 hover:bg-green-700 text-white"
                      disabled={addToScheduleMutation.isPending}
                    >
                      <Plus className="w-4 h-4 mr-2" /> {t("admin.add_btn")}
                    </Button>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                  {[1, 2, 3, 4, 5, 6].map((day) => {
                    const dayItems =
                      weeklySchedule?.filter((i) => i.dayOfWeek === day) || [];

                    return (
                      <Card key={day} className="bg-card">
                        <CardHeader className="py-3 px-4 border-b border-border bg-muted/20">
                          <CardTitle className="text-base capitalize text-center">
                            {dayMapping[day]}
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="p-2 space-y-2">
                          {dayItems.length === 0 ? (
                            <p className="text-xs text-center text-muted-foreground py-4">
                              {t("admin.empty")}
                            </p>
                          ) : (
                            dayItems.map((item) => (
                              <div
                                key={item.id}
                                className="flex items-center justify-between p-2 rounded-lg border border-border bg-background text-xs group"
                              >
                                <div>
                                  <div className="font-bold text-primary">
                                    {item.startTime} ({item.durationMinutes}m)
                                  </div>
                                  <div className="text-muted-foreground truncate max-w-[100px]">
                                    {item.student
                                      ? item.student.name
                                      : t("admin.available")}
                                  </div>
                                  <div className="font-mono text-[10px] opacity-70">
                                    {item.price} PLN
                                  </div>
                                </div>
                                <Button
                                  variant="ghost"
                                  size="icon"
                                  className="h-6 w-6 text-destructive opacity-0 group-hover:opacity-100 transition-opacity"
                                  onClick={() =>
                                    deleteFromScheduleMutation.mutate(item.id)
                                  }
                                >
                                  <Trash2 className="w-3 h-3" />
                                </Button>
                              </div>
                            ))
                          )}
                        </CardContent>
                      </Card>
                    );
                  })}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* --- ZAK≈ÅADKA 3: BAZA UCZNI√ìW --- */}
          <TabsContent value="students" className="space-y-6">
            <Card className="border-secondary/20 shadow-md h-[70vh] flex flex-col">
              <CardHeader className="flex flex-row justify-between items-center">
                <div>
                  <CardTitle className="flex items-center gap-2">
                    <Users className="w-5 h-5 text-primary" />
                    {t("admin.tab_students")}
                  </CardTitle>
                  <p className="text-sm text-muted-foreground">
                    {t("admin.students_list_desc")}
                  </p>
                </div>
                {/* PRZYCISK DODAWANIA NOWEGO UCZNIA */}
                <Dialog
                  open={isAddStudentOpen}
                  onOpenChange={setIsAddStudentOpen}
                >
                  <DialogTrigger asChild>
                    <Button className="gap-2">
                      <Plus className="w-4 h-4" /> {t("admin.add_student_btn")}
                    </Button>
                  </DialogTrigger>
                  <DialogContent className="sm:max-w-md bg-card border-border">
                    <DialogHeader>
                      <DialogTitle>{t("admin.add_student_title")}</DialogTitle>
                      <DialogDescription>
                        {t("auth.register_subtitle")}
                      </DialogDescription>
                    </DialogHeader>
                    <div className="grid gap-4 py-4">
                      <div className="space-y-2">
                        <Label>{t("auth.full_name")}</Label>
                        <Input
                          placeholder={t("auth.name_placeholder")}
                          value={newStudent.name}
                          onChange={(e) =>
                            setNewStudent({
                              ...newStudent,
                              name: e.target.value,
                            })
                          }
                        />
                      </div>
                      <div className="space-y-2">
                        <Label>{t("auth.username")}</Label>
                        <Input
                          placeholder={t("auth.username_placeholder")}
                          value={newStudent.username}
                          onChange={(e) =>
                            setNewStudent({
                              ...newStudent,
                              username: e.target.value,
                            })
                          }
                        />
                      </div>
                      <div className="space-y-2">
                        <Label>{t("admin.table.email")} (Opcjonalnie)</Label>
                        <Input
                          type="email"
                          placeholder="email@example.com"
                          value={newStudent.email}
                          onChange={(e) =>
                            setNewStudent({
                              ...newStudent,
                              email: e.target.value,
                            })
                          }
                        />
                      </div>
                      <div className="space-y-2">
                        <Label>{t("admin.table.phone")}</Label>
                        <Input
                          placeholder="123-456-789"
                          value={newStudent.phone}
                          onChange={(e) =>
                            setNewStudent({
                              ...newStudent,
                              phone: e.target.value,
                            })
                          }
                        />
                      </div>
                      <div className="space-y-2">
                        <Label>{t("admin.table.address")}</Label>
                        <Input
                          placeholder="Ulica, Miasto"
                          value={newStudent.address}
                          onChange={(e) =>
                            setNewStudent({
                              ...newStudent,
                              address: e.target.value,
                            })
                          }
                        />
                      </div>
                      <div className="space-y-2">
                        <Label>{t("auth.password")}</Label>
                        <Input
                          type="password"
                          placeholder={t("auth.password_placeholder")}
                          value={newStudent.password}
                          onChange={(e) =>
                            setNewStudent({
                              ...newStudent,
                              password: e.target.value,
                            })
                          }
                        />
                      </div>
                      <Button
                        onClick={handleAddStudent}
                        disabled={createUserMutation.isPending}
                      >
                        {createUserMutation.isPending && (
                          <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                        )}
                        {t("admin.add_student_submit")}
                      </Button>
                    </div>
                  </DialogContent>
                </Dialog>
              </CardHeader>
              <CardContent className="flex-1 overflow-auto">
                {students?.filter((s) => s.role === "student").length === 0 ? (
                  <div className="flex flex-col items-center justify-center h-full text-muted-foreground">
                    <Users className="w-12 h-12 mb-4 opacity-20" />
                    <p>{t("admin.no_students")}</p>
                  </div>
                ) : (
                  <div className="relative w-full overflow-auto">
                    <table className="w-full caption-bottom text-sm text-left">
                      <thead className="[&_tr]:border-b">
                        <tr className="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
                          <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                            {t("admin.table.id")}
                          </th>
                          <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                            {t("admin.table.name")}
                          </th>
                          <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                            {t("admin.table.username")}
                          </th>
                          <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                            {t("admin.table.email")}
                          </th>
                          <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                            {t("admin.table.phone")}
                          </th>
                          <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                            {t("admin.table.address")}
                          </th>
                          <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                            Akcje
                          </th>
                        </tr>
                      </thead>
                      <tbody className="[&_tr:last-child]:border-0">
                        {students
                          ?.filter((s) => s.role === "student")
                          .map((student) => (
                            <tr
                              key={student.id}
                              className="border-b transition-colors hover:bg-muted/50"
                            >
                              <td className="p-4 align-middle font-mono text-xs">
                                {student.id}
                              </td>
                              <td className="p-4 align-middle font-medium">
                                {student.name}
                              </td>
                              <td className="p-4 align-middle">
                                {student.username}
                              </td>
                              <td className="p-4 align-middle text-muted-foreground">
                                {student.email || "-"}
                              </td>
                              <td className="p-4 align-middle">
                                {student.phone || "-"}
                              </td>
                              <td className="p-4 align-middle">
                                {student.address || "-"}
                              </td>
                              <td className="p-4 align-middle">
                                <Button
                                  variant="ghost"
                                  size="icon"
                                  className="h-8 w-8 text-destructive hover:bg-destructive/10"
                                  onClick={() => {
                                    if (
                                      confirm(
                                        "Czy na pewno chcesz usunƒÖƒá tego ucznia? To usunie r√≥wnie≈º jego rezerwacje i przypisanie do grafiku."
                                      )
                                    ) {
                                      deleteUserMutation.mutate(student.id);
                                    }
                                  }}
                                >
                                  <Trash2 className="w-4 h-4" />
                                </Button>
                              </td>
                            </tr>
                          ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </div>
    </div>
  );
}
-------------------------------
import type { Express } from "express";
import type { Server } from "http";
import { setupAuth } from "./auth";
import { storage } from "./storage";
// ‚úÖ IMPORT SERWISU EMAIL
import { sendWaitlistNotification } from "./services/email";
import {
  insertSlotSchema,
  generateSlotsSchema,
  insertWaitlistSchema,
  insertWeeklyScheduleSchema,
  generateFromTemplateSchema,
  insertUserSchema,
  type User,
} from "@shared/schema";
import { z } from "zod";
import {
  addDays,
  setHours,
  setMinutes,
  parseISO,
  differenceInHours,
  format,
  getYear,
  getDay,
  addMinutes,
  areIntervalsOverlapping,
  differenceInMinutes,
} from "date-fns";
// ‚úÖ IMPORT LOKALIZACJI DO FORMATOWANIA DATY
import { pl } from "date-fns/locale";
import { scrypt, randomBytes } from "crypto";
import { promisify } from "util";
console.log("\n\n üî•üî•üî• CZYTA MNIE! NOWY KOD ZOSTA≈Å ZA≈ÅADOWANY! üî•üî•üî• \n\n");

const scryptAsync = promisify(scrypt);

async function hashPassword(password: string) {
  const salt = randomBytes(16).toString("hex");
  const buf = (await scryptAsync(password, salt, 64)) as Buffer;
  return `${buf.toString("hex")}.${salt}`;
}

// --- POMOCNIKI CZASU (STREFA PL) ---

function getWarsawHourMinute(date: Date) {
  const plTimeStr = date.toLocaleString("en-US", {
    timeZone: "Europe/Warsaw",
    hour12: false,
    hour: "2-digit",
    minute: "2-digit",
  });
  const [h, m] = plTimeStr.split(":").map(Number);
  return { h: h === 24 ? 0 : h, m };
}

function isWarsawTime(
  date: Date,
  targetDay: number,
  targetH: number,
  targetM: number
) {
  const day = getDay(date);
  const plDateStr = date.toLocaleString("en-US", {
    timeZone: "Europe/Warsaw",
    weekday: "short",
  });
  const daysMap: Record<string, number> = {
    Sun: 0,
    Mon: 1,
    Tue: 2,
    Wed: 3,
    Thu: 4,
    Fri: 5,
    Sat: 6,
  };
  const currentDay = daysMap[plDateStr.split(",")[0]] ?? day;

  if (currentDay !== targetDay) return false;

  const { h, m } = getWarsawHourMinute(date);
  return h === targetH && Math.abs(m - targetM) < 2;
}

const holidayCache = new Map<number, Set<string>>();

async function getPublicHolidays(year: number): Promise<Set<string>> {
  if (holidayCache.has(year)) {
    return holidayCache.get(year)!;
  }
  try {
    console.log(`Fetching public holidays for year ${year}...`);
    const response = await fetch(
      `https://date.nager.at/api/v3/PublicHolidays/${year}/PL`
    );
    if (!response.ok) return new Set();
    const data = (await response.json()) as { date: string }[];
    const holidays = new Set(data.map((h) => h.date));
    holidayCache.set(year, holidays);
    return holidays;
  } catch (error) {
    console.error("Failed to fetch holidays:", error);
    return new Set();
  }
}

// --- STA≈ÅY GRAFIK UCZNI√ìW ---
const FIXED_STUDENT_SCHEDULE = [
  { day: 1, start: "11:00", duration: 60, name: "Masia S." },
  { day: 1, start: "13:30", duration: 60, name: "Natasza Z." },
  { day: 1, start: "14:50", duration: 60, name: "Marcel M." },
  { day: 1, start: "16:30", duration: 60, name: "Martyna S." },
  { day: 1, start: "17:50", duration: 60, name: "Ksawery D." },
  { day: 1, start: "19:00", duration: 60, name: "Filip B." },
  { day: 2, start: "12:00", duration: 120, name: "Julka B." },
  { day: 2, start: "14:30", duration: 60, name: "Oskar Z." },
  { day: 2, start: "16:20", duration: 60, name: "Wiktor B." },
  { day: 2, start: "18:00", duration: 60, name: "Julka S." },
  { day: 2, start: "19:00", duration: 60, name: "Tobiasz S." },
  { day: 3, start: "12:00", duration: 60, name: "Franek L." },
  { day: 3, start: "14:40", duration: 60, name: "Mateusz M." },
  { day: 3, start: "16:15", duration: 90, name: "Olek P." },
  { day: 3, start: "18:00", duration: 60, name: "Olek ≈ö." },
  { day: 4, start: "12:10", duration: 60, name: "Ola S." },
  { day: 4, start: "14:50", duration: 60, name: "Micha≈Ç G." },
  { day: 4, start: "16:30", duration: 60, name: "Pawe≈Ç S." },
  { day: 4, start: "17:45", duration: 60, name: "Ma≈Çgosia K." },
  { day: 4, start: "19:00", duration: 60, name: "Adam L." },
  { day: 5, start: "13:30", duration: 60, name: "Oskar Z." },
  { day: 5, start: "14:30", duration: 60, name: "Pola M." },
  { day: 5, start: "16:30", duration: 60, name: "Natalia B." },
  { day: 5, start: "18:00", duration: 120, name: "Kacper M." },
  { day: 6, start: "08:45", duration: 90, name: "Micha≈Ç W." },
  { day: 6, start: "10:30", duration: 120, name: "Oliwia P." },
  { day: 6, start: "13:00", duration: 60, name: "Kacper D." },
  { day: 6, start: "14:30", duration: 60, name: "Janek P." },
  { day: 6, start: "15:30", duration: 60, name: "Oskar N." },
  { day: 6, start: "17:00", duration: 90, name: "Antek ≈ª." },
];

export async function registerRoutes(
  httpServer: Server,
  app: Express
): Promise<Server> {
  setupAuth(app);

  app.get("/api/users", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }
    res.header("Cache-Control", "no-store, max-age=0");
    const users = await storage.getAllUsers();
    res.json(users);
  });

  app.post("/api/users", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }

    try {
      const userData = insertUserSchema.parse(req.body);
      const existingUser = await storage.getUserByUsername(userData.username);
      if (existingUser) {
        return res.status(409).json({ message: "U≈ºytkownik ju≈º istnieje." });
      }
      const hashedPassword = await hashPassword(userData.password);
      const newUser = await storage.createUser({
        ...userData,
        password: hashedPassword,
        role: "student",
      });
      res.status(201).json(newUser);
    } catch (err) {
      if (err instanceof z.ZodError) {
        res.status(400).json({ message: err.issues[0].message });
      } else {
        res.status(500).json({ message: "Internal server error" });
      }
    }
  });

  app.delete("/api/users/:id", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }
    const id = parseInt(req.params.id);
    await storage.deleteUser(id);
    res.sendStatus(204);
  });

  // --- SLOTY ---

  app.get("/api/slots", async (req, res) => {
    try {
      const start = req.query.start
        ? new Date(req.query.start as string)
        : undefined;
      const end = req.query.end ? new Date(req.query.end as string) : undefined;

      const slots = await storage.getSlots(start, end);
      if (slots.length === 0) return res.json(slots);

      const years = new Set(slots.map((s) => getYear(s.startTime)));
      const holidaySets = await Promise.all(
        Array.from(years).map((y) => getPublicHolidays(y))
      );
      const allHolidays = new Set<string>();
      holidaySets.forEach((set) =>
        set.forEach((date) => allHolidays.add(date))
      );

      const filteredSlots = slots.filter((slot) => {
        if (slot.isBooked) return true;

        const dateStr = format(slot.startTime, "yyyy-MM-dd");
        if (allHolidays.has(dateStr)) return false;

        const dayOfWeek = getDay(slot.startTime);
        const dailyFixed = FIXED_STUDENT_SCHEDULE.filter(
          (l) => l.day === dayOfWeek
        );

        const slotPl = getWarsawHourMinute(slot.startTime);
        const slotStartMinutes = slotPl.h * 60 + slotPl.m;
        const duration = differenceInMinutes(slot.endTime, slot.startTime);
        const slotEndMinutes = slotStartMinutes + duration;

        const hasCollision = dailyFixed.some((fixedLesson) => {
          const [fh, fm] = fixedLesson.start.split(":").map(Number);
          const fixedStartMinutes = fh * 60 + fm;
          const fixedEndMinutes = fixedStartMinutes + fixedLesson.duration;

          return (
            slotStartMinutes < fixedEndMinutes &&
            slotEndMinutes > fixedStartMinutes
          );
        });

        if (hasCollision) return false;

        return true;
      });

      res.json(filteredSlots);
    } catch (err) {
      res.status(500).json({ message: "Failed to fetch slots" });
    }
  });

  app.post("/api/slots", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }
    try {
      const input = insertSlotSchema.parse(req.body);
      const slot = await storage.createSlot(input);
      res.status(201).json(slot);
    } catch (err) {
      res.status(400).json({ message: "Error creating slot" });
    }
  });

  app.patch("/api/slots/:id", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }
    try {
      const id = parseInt(req.params.id);
      const input = insertSlotSchema.partial().parse(req.body);
      const updated = await storage.updateSlot(id, input);
      res.json(updated);
    } catch (err) {
      res.status(500).json({ message: "Failed to update slot" });
    }
  });

  app.delete("/api/slots/:id", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }
    const id = parseInt(req.params.id);
    await storage.deleteSlot(id);
    res.sendStatus(204);
  });

  app.get("/api/weekly-schedule", async (req, res) => {
    if (!req.isAuthenticated()) return res.sendStatus(401);
    const schedule = await storage.getWeeklySchedule();
    res.json(schedule);
  });

  app.post("/api/weekly-schedule", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }
    try {
      const input = insertWeeklyScheduleSchema.parse(req.body);
      const item = await storage.createWeeklyScheduleItem(input);
      res.status(201).json(item);
    } catch (err) {
      res.status(500).json({ message: "Internal server error" });
    }
  });

  app.delete("/api/weekly-schedule/:id", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }
    const id = parseInt(req.params.id);
    await storage.deleteWeeklyScheduleItem(id);
    res.sendStatus(204);
  });

  // --- GENERATORY ---

  app.post("/api/slots/generate", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }
    try {
      const { startDate, endDate, startTime, endTime, duration } =
        generateSlotsSchema.parse(req.body);

      const start = parseISO(startDate);
      const end = parseISO(endDate);

      const startYear = getYear(start);
      const holidays = await getPublicHolidays(startYear);
      if (getYear(end) !== startYear) {
        const h2 = await getPublicHolidays(getYear(end));
        h2.forEach((h) => holidays.add(h));
      }

      const existingSlots = await storage.getSlots(start, addDays(end, 1));
      const existingTimestamps = new Set(
        existingSlots.map((s) => s.startTime.getTime())
      );

      const [startHour, startMinute] = startTime.split(":").map(Number);
      const [endHour, endMinute] = endTime.split(":").map(Number);

      let currentDay = start;
      let count = 0;

      while (currentDay <= end) {
        const dateStr = format(currentDay, "yyyy-MM-dd");
        const dayOfWeek = getDay(currentDay);

        if (holidays.has(dateStr)) {
          currentDay = addDays(currentDay, 1);
          continue;
        }

        if (dayOfWeek !== 0) {
          const fixedLessons = FIXED_STUDENT_SCHEDULE.filter(
            (l) => l.day === dayOfWeek
          );

          let daySlotStart = setMinutes(
            setHours(currentDay, startHour),
            startMinute
          );
          const daySlotEnd = setMinutes(
            setHours(currentDay, endHour),
            endMinute
          );

          while (daySlotStart < daySlotEnd) {
            const slotEnd = addMinutes(daySlotStart, duration);
            if (slotEnd > daySlotEnd) break;

            const { h: slotH, m: slotM } = getWarsawHourMinute(daySlotStart);
            const slotStartMin = slotH * 60 + slotM;
            const slotEndMin = slotStartMin + duration;

            const isCollision = fixedLessons.some((lesson) => {
              const [lh, lm] = lesson.start.split(":").map(Number);
              const lessonStartMin = lh * 60 + lm;
              const lessonEndMin = lessonStartMin + lesson.duration;

              return slotStartMin < lessonEndMin && slotEndMin > lessonStartMin;
            });

            if (
              !isCollision &&
              !existingTimestamps.has(daySlotStart.getTime())
            ) {
              await storage.createSlot({
                startTime: daySlotStart,
                endTime: slotEnd,
                isBooked: false,
                isPaid: false,
              });
              count++;
            }
            daySlotStart = slotEnd;
          }
        }
        currentDay = addDays(currentDay, 1);
      }

      res.status(201).json({ count });
    } catch (err) {
      console.error(err);
      res.status(500).json({ message: "Failed to generate slots" });
    }
  });

  app.post("/api/slots/generate-from-template", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }

    try {
      const { startDate, endDate } = generateFromTemplateSchema.parse(req.body);
      const start = parseISO(startDate);
      const end = parseISO(endDate);

      const allUsers = await storage.getAllUsers();

      const startYear = getYear(start);
      const holidays = await getPublicHolidays(startYear);
      if (getYear(end) !== startYear) {
        const h2 = await getPublicHolidays(getYear(end));
        h2.forEach((h) => holidays.add(h));
      }

      const existingSlots = await storage.getSlots(start, addDays(end, 1));

      let currentDay = start;
      let count = 0;
      let updatedCount = 0;

      while (currentDay <= end) {
        const dateStr = format(currentDay, "yyyy-MM-dd");

        if (holidays.has(dateStr)) {
          console.log(`Skipping holiday: ${dateStr}`);
          currentDay = addDays(currentDay, 1);
          continue;
        }

        const dayOfWeek = getDay(currentDay);
        const dayTemplates = FIXED_STUDENT_SCHEDULE.filter(
          (t) => t.day === dayOfWeek
        );

        for (const item of dayTemplates) {
          const [hours, minutes] = item.start.split(":").map(Number);

          let slotStart = setMinutes(setHours(currentDay, hours), minutes);
          const offsetCheck = getWarsawHourMinute(slotStart);
          const diffH = hours - offsetCheck.h;
          if (diffH !== 0) {
            slotStart = addMinutes(slotStart, diffH * 60);
          }

          const slotEnd = addMinutes(slotStart, item.duration);

          const student = allUsers.find(
            (u) =>
              u.name?.toLowerCase().trim() === item.name.toLowerCase().trim() ||
              u.username.toLowerCase().trim() === item.name.toLowerCase().trim()
          );

          const existingSlot = existingSlots.find(
            (s) => Math.abs(differenceInMinutes(s.startTime, slotStart)) < 2
          );

          if (existingSlot) {
            await storage.updateSlot(existingSlot.id, {
              isBooked: true,
              studentId: student ? student.id : null,
              topic: item.name,
              endTime: slotEnd,
            });
            updatedCount++;
          } else {
            await storage.createSlot({
              startTime: slotStart,
              endTime: slotEnd,
              isBooked: true,
              studentId: student ? student.id : null,
              isPaid: false,
              topic: item.name,
            });
            count++;
          }
        }

        currentDay = addDays(currentDay, 1);
      }

      res.status(201).json({
        count,
        message: `Zaktualizowano ${updatedCount}, utworzono ${count} lekcji.`,
      });
    } catch (err) {
      console.error(err);
      res.status(500).json({ message: "Failed to generate schedule" });
    }
  });

  app.post("/api/slots/:id/book", async (req, res) => {
    if (!req.isAuthenticated()) return res.sendStatus(401);
    const user = req.user as User;

    try {
      const id = parseInt(req.params.id);
      const slot = await storage.getSlot(id);
      if (!slot) return res.status(404).send("Slot not found");
      if (slot.isBooked) return res.status(409).send("Slot already booked");

      const updated = await storage.updateSlot(id, {
        isBooked: true,
        studentId: user.id,
      });
      res.json(updated);
    } catch (err) {
      res.status(500).send("Error booking slot");
    }
  });

  // ‚úÖ ENDPOINT Z FUNKCJƒÑ LOGOWANIA
  app.post("/api/slots/:id/cancel", async (req, res) => {
    console.log(
      `[DEBUG] Received Cancel Request for slot ID: ${req.params.id}`
    ); // <--- PIERWSZY DEBUG

    if (!req.isAuthenticated()) return res.sendStatus(401);
    const user = req.user as User;

    try {
      const id = parseInt(req.params.id);
      const slot = await storage.getSlot(id);
      if (!slot) return res.status(404).send("Slot not found");

      if (user.role !== "admin" && slot.studentId !== user.id) {
        return res.status(403).send("Not authorized");
      }

      if (user.role !== "admin") {
        const hoursUntilLesson = differenceInHours(
          new Date(slot.startTime),
          new Date()
        );
        if (hoursUntilLesson < 24) {
          return res.status(400).json({
            message: "Too late to cancel. Contact admin directly.",
          });
        }
      }

      const updated = await storage.updateSlot(id, {
        isBooked: false,
        studentId: null,
        isPaid: false,
        topic: null,
      });

      console.log(`[DEBUG] Slot ${id} cancelled successfully.`);

      // --- WYSY≈ÅANIE POWIADOMIENIA ---
      const slotDate = new Date(slot.startTime);

      console.log(`[DEBUG] Attempting to send waitlist notification...`);
      await sendWaitlistNotification({
        email: "przykladowy@uczen.pl",
        name: "OczekujƒÖcy Ucze≈Ñ",
        date: format(slotDate, "dd MMMM yyyy", { locale: pl }),
        time: format(slotDate, "HH:mm"),
      });
      // ---------------------------------

      res.json(updated);
    } catch (err) {
      console.error(err);
      res.status(500).send("Error cancelling slot");
    }
  });

  app.post("/api/waitlist", async (req, res) => {
    if (!req.isAuthenticated()) return res.sendStatus(401);
    const user = req.user as User;
    try {
      const input = insertWaitlistSchema.parse({
        ...req.body,
        userId: user.id,
      });
      const entry = await storage.addToWaitlist(input);
      res.status(201).json(entry);
    } catch (err) {
      res.status(400).json({ message: "Invalid request" });
    }
  });

  if (process.env.NODE_ENV !== "production") {
    const adminUser = await storage.getUserByUsername("admin");
    if (!adminUser) {
      const adminPass = await hashPassword("admin123");
      await storage.createUser({
        username: "admin",
        password: adminPass,
        role: "admin",
        name: "Math Tutor",
      });
    }
  }

  return httpServer;
}
---------------------------------
import { useUser, useChangePassword } from "@/hooks/use-auth";
import { useSlots, useCancelSlot } from "@/hooks/use-slots";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormMessage,
} from "@/components/ui/form";
import { Loader2, Calendar, Clock, XCircle } from "lucide-react";
import {
  format,
  formatDistanceToNow,
  isFuture,
  subDays,
  addYears,
} from "date-fns";
import { pl } from "date-fns/locale";
import { Link } from "wouter";
import { useMemo } from "react";

const passwordSchema = z.object({
  currentPassword: z.string().min(1, "Current password is required"),
  newPassword: z.string().min(6, "Password must be at least 6 characters"),
});

export default function DashboardPage() {
  const { data: user } = useUser();

  // ZMIANA: Pobieramy sloty od wczoraj (bezpieczny bufor na strefy czasowe)
  const dateRange = useMemo(() => {
    const start = subDays(new Date(), 1).toISOString(); // Od wczoraj
    const end = addYears(new Date(), 1).toISOString(); // Do przysz≈Çego roku
    return { start, end };
  }, []);

  const { data: slots, isLoading: slotsLoading } = useSlots(dateRange);

  const cancelSlotMutation = useCancelSlot();
  const changePasswordMutation = useChangePassword();

  const form = useForm<z.infer<typeof passwordSchema>>({
    resolver: zodResolver(passwordSchema),
    defaultValues: {
      currentPassword: "",
      newPassword: "",
    },
  });

  // Filtrowanie i sortowanie lekcji
  const myUpcomingSlots = useMemo(() => {
    if (!slots || !user) return [];

    console.log("--- DEBUG DASHBOARD ---");
    console.log("Wszystkich slot√≥w z API:", slots.length);
    console.log("M√≥j User ID:", user.id);

    const mySlots = slots.filter((slot) => {
      // Por√≥wnujemy ID (bezpieczne rzutowanie na Number)
      const isMySlot = Number(slot.studentId) === Number(user.id);
      // Sprawdzamy czy data jest w przysz≈Ço≈õci
      const isFutureSlot = isFuture(new Date(slot.startTime));

      if (isMySlot && !isFutureSlot) {
        console.log(
          "Znaleziono mojƒÖ lekcjƒô, ale jest w przesz≈Ço≈õci:",
          slot.startTime
        );
      }

      return isMySlot && isFutureSlot;
    });

    console.log("Moje nadchodzƒÖce lekcje (po filtrze):", mySlots.length);

    return mySlots.sort(
      (a, b) =>
        new Date(a.startTime).getTime() - new Date(b.startTime).getTime()
    );
  }, [slots, user]);

  const nextLesson = myUpcomingSlots[0];

  function onPasswordSubmit(data: z.infer<typeof passwordSchema>) {
    changePasswordMutation.mutate(data, {
      onSuccess: () => form.reset(),
    });
  }

  if (slotsLoading) {
    return (
      <div className="flex items-center justify-center min-h-[50vh]">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
      </div>
    );
  }

  return (
    <div className="container mx-auto px-4 py-8 space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-700">
      {/* NAG≈Å√ìWEK */}
      <div>
        <h1 className="text-3xl font-bold tracking-tight">
          Cze≈õƒá, {user?.name || user?.username}!
        </h1>
        <p className="text-muted-foreground mt-2">
          Mi≈Ço Ciƒô widzieƒá z powrotem. Gotowy na matematykƒô?
        </p>
      </div>

      <div className="grid gap-6 md:grid-cols-2">
        {/* LEWA KOLUMNA - LEKCJE */}
        <div className="space-y-6">
          {/* NASTƒòPNA LEKCJA (LICZNIK) */}
          <Card className="bg-primary text-primary-foreground border-none shadow-lg">
            <CardHeader>
              <CardTitle className="text-lg opacity-90">
                Nastƒôpna lekcja za
              </CardTitle>
            </CardHeader>
            <CardContent>
              {nextLesson ? (
                <div className="space-y-2">
                  <div className="text-4xl font-bold tracking-tighter">
                    {formatDistanceToNow(new Date(nextLesson.startTime), {
                      locale: pl,
                    })}
                  </div>
                  <div className="text-lg opacity-90 font-medium">
                    {format(
                      new Date(nextLesson.startTime),
                      "d MMMM yyyy, HH:mm",
                      { locale: pl }
                    )}
                  </div>
                </div>
              ) : (
                <div className="text-lg opacity-90">
                  Brak zaplanowanych lekcji.
                </div>
              )}
            </CardContent>
          </Card>

          {/* LISTA NADCHODZƒÑCYCH LEKCJI */}
          <Card>
            <CardHeader className="flex flex-row items-center justify-between">
              <CardTitle>NadchodzƒÖce lekcje</CardTitle>
              <Button variant="outline" size="sm" asChild>
                <Link href="/booking">Zarezerwuj</Link>
              </Button>
            </CardHeader>
            <CardContent>
              {myUpcomingSlots.length === 0 ? (
                <div className="text-center py-6 text-muted-foreground">
                  Brak nadchodzƒÖcych lekcji.
                  <br />
                  <Link
                    href="/booking"
                    className="text-primary hover:underline mt-2 inline-block"
                  >
                    Zarezerwuj pierwszƒÖ lekcjƒô
                  </Link>
                </div>
              ) : (
                <div className="space-y-4">
                  {myUpcomingSlots.map((slot) => (
                    <div
                      key={slot.id}
                      className="flex items-center justify-between p-4 rounded-lg border bg-card hover:bg-accent/5 transition-colors"
                    >
                      <div className="space-y-1">
                        <div className="font-semibold flex items-center gap-2">
                          <Calendar className="h-4 w-4 text-primary" />
                          {format(new Date(slot.startTime), "d MMMM yyyy", {
                            locale: pl,
                          })}
                        </div>
                        <div className="text-sm text-muted-foreground flex items-center gap-2">
                          <Clock className="h-4 w-4" />
                          {format(new Date(slot.startTime), "HH:mm")} -{" "}
                          {format(new Date(slot.endTime), "HH:mm")}
                        </div>
                        <div className="flex gap-2 mt-1">
                          <span
                            className={`text-xs px-2 py-0.5 rounded-full ${
                              slot.isPaid
                                ? "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400"
                                : "bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400"
                            }`}
                          >
                            {slot.isPaid ? "Op≈Çacone" : "Nieop≈Çacone"}
                          </span>
                        </div>
                      </div>

                      {/* PRZYCISK ANULOWANIA */}
                      <Button
                        variant="destructive"
                        size="sm"
                        className="gap-2"
                        onClick={() => {
                          if (
                            confirm("Czy na pewno chcesz anulowaƒá tƒô lekcjƒô?")
                          ) {
                            cancelSlotMutation.mutate(slot.id);
                          }
                        }}
                        disabled={cancelSlotMutation.isPending}
                      >
                        {cancelSlotMutation.isPending ? (
                          <Loader2 className="h-4 w-4 animate-spin" />
                        ) : (
                          <XCircle className="h-4 w-4" />
                        )}
                        Anuluj
                      </Button>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        </div>

        {/* PRAWA KOLUMNA - ZMIANA HAS≈ÅA */}
        <div className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Zmiana Has≈Ça</CardTitle>
            </CardHeader>
            <CardContent>
              <Form {...form}>
                <form
                  onSubmit={form.handleSubmit(onPasswordSubmit)}
                  className="space-y-4"
                >
                  <FormField
                    control={form.control}
                    name="currentPassword"
                    render={({ field }) => (
                      <FormItem>
                        <Label>Obecne has≈Ço</Label>
                        <FormControl>
                          <Input type="password" {...field} />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                  <FormField
                    control={form.control}
                    name="newPassword"
                    render={({ field }) => (
                      <FormItem>
                        <Label>Nowe has≈Ço</Label>
                        <FormControl>
                          <Input type="password" {...field} />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                  <Button
                    type="submit"
                    className="w-full"
                    disabled={changePasswordMutation.isPending}
                  >
                    {changePasswordMutation.isPending && (
                      <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    )}
                    Zmie≈Ñ has≈Ço
                  </Button>
                </form>
              </Form>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
}
---------------------------------
// Interfejs dla danych do powiadomienia
interface WaitlistNotificationParams {
  email: string;
  name: string;
  date: string;
  time: string;
}

// Funkcja symulujƒÖca wysy≈Çkƒô maila (loguje tre≈õƒá do konsoli serwera)
export async function sendWaitlistNotification({
  email,
  name,
  date,
  time,
}: WaitlistNotificationParams) {
  console.log("\n\n===================================================");
  console.log(`üìß [EMAIL MOCK] SYMULACJA WYSY≈ÅANIA MAILA`);
  console.log(`---------------------------------------------------`);
  console.log(`DO:      ${email}`);
  console.log(`TEMAT:   Wolny termin: ${date} o ${time}!`);
  console.log(`TRE≈öƒÜ:   Cze≈õƒá ${name},`);
  console.log(
    `Zwolni≈Ç siƒô termin na korepetycje w dniu ${date} o godzinie ${time}.`
  );
  console.log(`Zaloguj siƒô szybko na MathMentor, aby go zarezerwowaƒá!`);
  console.log("===================================================\n\n");

  return true;
}
---------------------------------
import type { Express } from "express";
import type { Server } from "http";
import { setupAuth } from "./auth";
import { storage } from "./storage";
// ‚úÖ IMPORT SERWISU EMAIL
import { sendWaitlistNotification } from "./services/email";
import {
  insertSlotSchema,
  generateSlotsSchema,
  insertWaitlistSchema,
  insertWeeklyScheduleSchema,
  generateFromTemplateSchema,
  insertUserSchema,
  type User,
} from "@shared/schema";
import { z } from "zod";
import {
  addDays,
  setHours,
  setMinutes,
  parseISO,
  differenceInHours,
  format,
  getYear,
  getDay,
  addMinutes,
  areIntervalsOverlapping,
  differenceInMinutes,
} from "date-fns";
// ‚úÖ IMPORT LOKALIZACJI DO FORMATOWANIA DATY
import { pl } from "date-fns/locale";
import { scrypt, randomBytes } from "crypto";
import { promisify } from "util";
console.log("\n\n üî•üî•üî• CZYTA MNIE! NOWY KOD ZOSTA≈Å ZA≈ÅADOWANY! üî•üî•üî• \n\n");

const scryptAsync = promisify(scrypt);

async function hashPassword(password: string) {
  const salt = randomBytes(16).toString("hex");
  const buf = (await scryptAsync(password, salt, 64)) as Buffer;
  return `${buf.toString("hex")}.${salt}`;
}

// --- POMOCNIKI CZASU (STREFA PL) ---

function getWarsawHourMinute(date: Date) {
  const plTimeStr = date.toLocaleString("en-US", {
    timeZone: "Europe/Warsaw",
    hour12: false,
    hour: "2-digit",
    minute: "2-digit",
  });
  const [h, m] = plTimeStr.split(":").map(Number);
  return { h: h === 24 ? 0 : h, m };
}

function isWarsawTime(
  date: Date,
  targetDay: number,
  targetH: number,
  targetM: number
) {
  const day = getDay(date);
  const plDateStr = date.toLocaleString("en-US", {
    timeZone: "Europe/Warsaw",
    weekday: "short",
  });
  const daysMap: Record<string, number> = {
    Sun: 0,
    Mon: 1,
    Tue: 2,
    Wed: 3,
    Thu: 4,
    Fri: 5,
    Sat: 6,
  };
  const currentDay = daysMap[plDateStr.split(",")[0]] ?? day;

  if (currentDay !== targetDay) return false;

  const { h, m } = getWarsawHourMinute(date);
  return h === targetH && Math.abs(m - targetM) < 2;
}

const holidayCache = new Map<number, Set<string>>();

async function getPublicHolidays(year: number): Promise<Set<string>> {
  if (holidayCache.has(year)) {
    return holidayCache.get(year)!;
  }
  try {
    console.log(`Fetching public holidays for year ${year}...`);
    const response = await fetch(
      `https://date.nager.at/api/v3/PublicHolidays/${year}/PL`
    );
    if (!response.ok) return new Set();
    const data = (await response.json()) as { date: string }[];
    const holidays = new Set(data.map((h) => h.date));
    holidayCache.set(year, holidays);
    return holidays;
  } catch (error) {
    console.error("Failed to fetch holidays:", error);
    return new Set();
  }
}

export async function registerRoutes(
  httpServer: Server,
  app: Express
): Promise<Server> {
  setupAuth(app);

  app.get("/api/users", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }
    res.header("Cache-Control", "no-store, max-age=0");
    const users = await storage.getAllUsers();
    res.json(users);
  });

  app.post("/api/users", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }

    try {
      const userData = insertUserSchema.parse(req.body);
      const existingUser = await storage.getUserByUsername(userData.username);
      if (existingUser) {
        return res.status(409).json({ message: "U≈ºytkownik ju≈º istnieje." });
      }
      const hashedPassword = await hashPassword(userData.password);
      const newUser = await storage.createUser({
        ...userData,
        password: hashedPassword,
        role: "student",
      });
      res.status(201).json(newUser);
    } catch (err) {
      if (err instanceof z.ZodError) {
        res.status(400).json({ message: err.issues[0].message });
      } else {
        res.status(500).json({ message: "Internal server error" });
      }
    }
  });

  app.delete("/api/users/:id", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }
    const id = parseInt(req.params.id);
    await storage.deleteUser(id);
    res.sendStatus(204);
  });

  // --- SLOTY ---

  app.get("/api/slots", async (req, res) => {
    try {
      const start = req.query.start
        ? new Date(req.query.start as string)
        : undefined;
      const end = req.query.end ? new Date(req.query.end as string) : undefined;

      const slots = await storage.getSlots(start, end);
      if (slots.length === 0) return res.json(slots);

      const years = new Set(slots.map((s) => getYear(s.startTime)));
      const holidaySets = await Promise.all(
        Array.from(years).map((y) => getPublicHolidays(y))
      );
      const allHolidays = new Set<string>();
      holidaySets.forEach((set) =>
        set.forEach((date) => allHolidays.add(date))
      );

      // Pobieramy szablon z bazy, aby sprawdziƒá kolizje (logika filtrowania)
      const weeklySchedule = await storage.getWeeklySchedule();

      const filteredSlots = slots.filter((slot) => {
        if (slot.isBooked) return true;

        const dateStr = format(slot.startTime, "yyyy-MM-dd");
        if (allHolidays.has(dateStr)) return false;

        const dayOfWeek = getDay(slot.startTime);
        const dailyFixed = weeklySchedule.filter(
          (l) => l.dayOfWeek === dayOfWeek
        );

        const slotPl = getWarsawHourMinute(slot.startTime);
        const slotStartMinutes = slotPl.h * 60 + slotPl.m;
        const duration = differenceInMinutes(slot.endTime, slot.startTime);
        const slotEndMinutes = slotStartMinutes + duration;

        const hasCollision = dailyFixed.some((fixedLesson) => {
          const [fh, fm] = fixedLesson.startTime.split(":").map(Number);
          const fixedStartMinutes = fh * 60 + fm;
          const fixedEndMinutes =
            fixedStartMinutes + fixedLesson.durationMinutes;

          return (
            slotStartMinutes < fixedEndMinutes &&
            slotEndMinutes > fixedStartMinutes
          );
        });

        if (hasCollision) return false;

        return true;
      });

      res.json(filteredSlots);
    } catch (err) {
      res.status(500).json({ message: "Failed to fetch slots" });
    }
  });

  app.post("/api/slots", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }
    try {
      const input = insertSlotSchema.parse(req.body);
      const slot = await storage.createSlot(input);
      res.status(201).json(slot);
    } catch (err) {
      res.status(400).json({ message: "Error creating slot" });
    }
  });

  app.patch("/api/slots/:id", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }
    try {
      const id = parseInt(req.params.id);
      const input = insertSlotSchema.partial().parse(req.body);
      const updated = await storage.updateSlot(id, input);
      res.json(updated);
    } catch (err) {
      res.status(500).json({ message: "Failed to update slot" });
    }
  });

  app.delete("/api/slots/:id", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }
    const id = parseInt(req.params.id);
    await storage.deleteSlot(id);
    res.sendStatus(204);
  });

  app.get("/api/weekly-schedule", async (req, res) => {
    if (!req.isAuthenticated()) return res.sendStatus(401);
    const schedule = await storage.getWeeklySchedule();
    res.json(schedule);
  });

  app.post("/api/weekly-schedule", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }
    try {
      const input = insertWeeklyScheduleSchema.parse(req.body);
      const item = await storage.createWeeklyScheduleItem(input);
      res.status(201).json(item);
    } catch (err) {
      res.status(500).json({ message: "Internal server error" });
    }
  });

  app.delete("/api/weekly-schedule/:id", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }
    const id = parseInt(req.params.id);
    await storage.deleteWeeklyScheduleItem(id);
    res.sendStatus(204);
  });

  // --- GENERATORY ---

  app.post("/api/slots/generate", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }
    try {
      const { startDate, endDate, startTime, endTime, duration } =
        generateSlotsSchema.parse(req.body);

      const start = parseISO(startDate);
      const end = parseISO(endDate);

      const startYear = getYear(start);
      const holidays = await getPublicHolidays(startYear);
      if (getYear(end) !== startYear) {
        const h2 = await getPublicHolidays(getYear(end));
        h2.forEach((h) => holidays.add(h));
      }

      const existingSlots = await storage.getSlots(start, addDays(end, 1));
      const existingTimestamps = new Set(
        existingSlots.map((s) => s.startTime.getTime())
      );

      const [startHour, startMinute] = startTime.split(":").map(Number);
      const [endHour, endMinute] = endTime.split(":").map(Number);

      // Pobieramy szablon z bazy
      const weeklySchedule = await storage.getWeeklySchedule();

      let currentDay = start;
      let count = 0;

      while (currentDay <= end) {
        const dateStr = format(currentDay, "yyyy-MM-dd");
        const dayOfWeek = getDay(currentDay);

        if (holidays.has(dateStr)) {
          currentDay = addDays(currentDay, 1);
          continue;
        }

        if (dayOfWeek !== 0) {
          const fixedLessons = weeklySchedule.filter(
            (l) => l.dayOfWeek === dayOfWeek
          );

          let daySlotStart = setMinutes(
            setHours(currentDay, startHour),
            startMinute
          );
          const daySlotEnd = setMinutes(
            setHours(currentDay, endHour),
            endMinute
          );

          while (daySlotStart < daySlotEnd) {
            const slotEnd = addMinutes(daySlotStart, duration);
            if (slotEnd > daySlotEnd) break;

            const { h: slotH, m: slotM } = getWarsawHourMinute(daySlotStart);
            const slotStartMin = slotH * 60 + slotM;
            const slotEndMin = slotStartMin + duration;

            const isCollision = fixedLessons.some((lesson) => {
              const [lh, lm] = lesson.startTime.split(":").map(Number);
              const lessonStartMin = lh * 60 + lm;
              const lessonEndMin = lessonStartMin + lesson.durationMinutes;

              return slotStartMin < lessonEndMin && slotEndMin > lessonStartMin;
            });

            if (
              !isCollision &&
              !existingTimestamps.has(daySlotStart.getTime())
            ) {
              await storage.createSlot({
                startTime: daySlotStart,
                endTime: slotEnd,
                isBooked: false,
                isPaid: false,
              });
              count++;
            }
            daySlotStart = slotEnd;
          }
        }
        currentDay = addDays(currentDay, 1);
      }

      res.status(201).json({ count });
    } catch (err) {
      console.error(err);
      res.status(500).json({ message: "Failed to generate slots" });
    }
  });

  app.post("/api/slots/generate-from-template", async (req, res) => {
    const user = req.user as User;
    if (!req.isAuthenticated() || user.role !== "admin") {
      return res.status(403).send("Unauthorized");
    }

    try {
      const { startDate, endDate } = generateFromTemplateSchema.parse(req.body);
      const start = parseISO(startDate);
      const end = parseISO(endDate);

      // Pobieramy szablon z bazy danych
      const weeklySchedule = await storage.getWeeklySchedule();

      const startYear = getYear(start);
      const holidays = await getPublicHolidays(startYear);
      if (getYear(end) !== startYear) {
        const h2 = await getPublicHolidays(getYear(end));
        h2.forEach((h) => holidays.add(h));
      }

      const existingSlots = await storage.getSlots(start, addDays(end, 1));

      let currentDay = start;
      let count = 0;
      let updatedCount = 0;

      while (currentDay <= end) {
        const dateStr = format(currentDay, "yyyy-MM-dd");

        if (holidays.has(dateStr)) {
          console.log(`Skipping holiday: ${dateStr}`);
          currentDay = addDays(currentDay, 1);
          continue;
        }

        const dayOfWeek = getDay(currentDay);
        // Filtrujemy szablon z bazy
        const dayTemplates = weeklySchedule.filter(
          (t) => t.dayOfWeek === dayOfWeek
        );

        for (const item of dayTemplates) {
          const [hours, minutes] = item.startTime.split(":").map(Number);

          let slotStart = setMinutes(setHours(currentDay, hours), minutes);
          const offsetCheck = getWarsawHourMinute(slotStart);
          const diffH = hours - offsetCheck.h;
          if (diffH !== 0) {
            slotStart = addMinutes(slotStart, diffH * 60);
          }

          const slotEnd = addMinutes(slotStart, item.durationMinutes);

          // Szukamy istniejƒÖcego slotu w bazie (z tolerancjƒÖ 2 min)
          const existingSlot = existingSlots.find(
            (s) => Math.abs(differenceInMinutes(s.startTime, slotStart)) < 2
          );

          if (existingSlot) {
            await storage.updateSlot(existingSlot.id, {
              isBooked: true,
              studentId: item.studentId, // Przypisujemy ID studenta z szablonu
              topic: item.student?.name || "Matematyka", // Opcjonalnie nazwa
              endTime: slotEnd,
              price: item.price,
            });
            updatedCount++;
          } else {
            await storage.createSlot({
              startTime: slotStart,
              endTime: slotEnd,
              isBooked: true,
              studentId: item.studentId, // Przypisujemy ID studenta z szablonu
              isPaid: false,
              topic: item.student?.name || "Matematyka",
              price: item.price,
            });
            count++;
          }
        }

        currentDay = addDays(currentDay, 1);
      }

      res.status(201).json({
        count,
        message: `Zaktualizowano ${updatedCount}, utworzono ${count} lekcji.`,
      });
    } catch (err) {
      console.error(err);
      res.status(500).json({ message: "Failed to generate schedule" });
    }
  });

  app.post("/api/slots/:id/book", async (req, res) => {
    if (!req.isAuthenticated()) return res.sendStatus(401);
    const user = req.user as User;

    try {
      const id = parseInt(req.params.id);
      const slot = await storage.getSlot(id);
      if (!slot) return res.status(404).send("Slot not found");
      if (slot.isBooked) return res.status(409).send("Slot already booked");

      const updated = await storage.updateSlot(id, {
        isBooked: true,
        studentId: user.id,
      });
      res.json(updated);
    } catch (err) {
      res.status(500).send("Error booking slot");
    }
  });

  // ‚úÖ ENDPOINT Z FUNKCJƒÑ LOGOWANIA
  app.post("/api/slots/:id/cancel", async (req, res) => {
    console.log(
      `[DEBUG] Received Cancel Request for slot ID: ${req.params.id}`
    ); // <--- PIERWSZY DEBUG

    if (!req.isAuthenticated()) return res.sendStatus(401);
    const user = req.user as User;

    try {
      const id = parseInt(req.params.id);
      const slot = await storage.getSlot(id);
      if (!slot) return res.status(404).send("Slot not found");

      if (user.role !== "admin" && slot.studentId !== user.id) {
        return res.status(403).send("Not authorized");
      }

      if (user.role !== "admin") {
        const hoursUntilLesson = differenceInHours(
          new Date(slot.startTime),
          new Date()
        );
        if (hoursUntilLesson < 24) {
          return res.status(400).json({
            message: "Too late to cancel. Contact admin directly.",
          });
        }
      }

      const updated = await storage.updateSlot(id, {
        isBooked: false,
        studentId: null,
        isPaid: false,
        topic: null,
      });

      console.log(`[DEBUG] Slot ${id} cancelled successfully.`);

      // --- WYSY≈ÅANIE POWIADOMIENIA ---
      const slotDate = new Date(slot.startTime);

      console.log(`[DEBUG] Attempting to send waitlist notification...`);
      await sendWaitlistNotification({
        email: "przykladowy@uczen.pl",
        name: "OczekujƒÖcy Ucze≈Ñ",
        date: format(slotDate, "dd MMMM yyyy", { locale: pl }),
        time: format(slotDate, "HH:mm"),
      });
      // ---------------------------------

      res.json(updated);
    } catch (err) {
      console.error(err);
      res.status(500).send("Error cancelling slot");
    }
  });

  app.post("/api/waitlist", async (req, res) => {
    if (!req.isAuthenticated()) return res.sendStatus(401);
    const user = req.user as User;
    try {
      const input = insertWaitlistSchema.parse({
        ...req.body,
        userId: user.id,
      });
      const entry = await storage.addToWaitlist(input);
      res.status(201).json(entry);
    } catch (err) {
      res.status(400).json({ message: "Invalid request" });
    }
  });

  if (process.env.NODE_ENV !== "production") {
    const adminUser = await storage.getUserByUsername("admin");
    if (!adminUser) {
      const adminPass = await hashPassword("admin123");
      await storage.createUser({
        username: "admin",
        password: adminPass,
        role: "admin",
        name: "Math Tutor",
      });
    }
  }

  return httpServer;
}
---------------------------------
import { useUser, useChangePassword } from "@/hooks/use-auth";
import { useSlots, useCancelSlot } from "@/hooks/use-slots";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormMessage,
} from "@/components/ui/form";
import { Loader2, Calendar, Clock, XCircle } from "lucide-react";
import {
  format,
  formatDistanceToNow,
  isFuture,
  subDays,
  addYears,
} from "date-fns";
import { pl } from "date-fns/locale";
import { Link } from "wouter";
import { useMemo } from "react";

const passwordSchema = z.object({
  currentPassword: z.string().min(1, "Current password is required"),
  newPassword: z.string().min(6, "Password must be at least 6 characters"),
});

export default function DashboardPage() {
  const { data: user } = useUser();

  // ZMIANA: Pobieramy sloty od wczoraj (bezpieczny bufor na strefy czasowe)
  const dateRange = useMemo(() => {
    const start = subDays(new Date(), 1).toISOString(); // Od wczoraj
    const end = addYears(new Date(), 1).toISOString(); // Do przysz≈Çego roku
    return { start, end };
  }, []);

  const { data: slots, isLoading: slotsLoading } = useSlots(dateRange);

  const cancelSlotMutation = useCancelSlot();
  const changePasswordMutation = useChangePassword();

  const form = useForm<z.infer<typeof passwordSchema>>({
    resolver: zodResolver(passwordSchema),
    defaultValues: {
      currentPassword: "",
      newPassword: "",
    },
  });

  // Filtrowanie i sortowanie lekcji
  const myUpcomingSlots = useMemo(() => {
    if (!slots || !user) return [];

    const mySlots = slots.filter((slot) => {
      // Por√≥wnujemy ID (bezpieczne rzutowanie na Number)
      const isMySlot = Number(slot.studentId) === Number(user.id);
      // Sprawdzamy czy data jest w przysz≈Ço≈õci
      const isFutureSlot = isFuture(new Date(slot.startTime));

      return isMySlot && isFutureSlot;
    });

    return mySlots.sort(
      (a, b) =>
        new Date(a.startTime).getTime() - new Date(b.startTime).getTime()
    );
  }, [slots, user]);

  const nextLesson = myUpcomingSlots[0];

  function onPasswordSubmit(data: z.infer<typeof passwordSchema>) {
    changePasswordMutation.mutate(data, {
      onSuccess: () => form.reset(),
    });
  }

  if (slotsLoading) {
    return (
      <div className="flex items-center justify-center min-h-[50vh]">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
      </div>
    );
  }

  return (
    <div className="container mx-auto px-4 py-8 space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-700">
      {/* NAG≈Å√ìWEK */}
      <div>
        <h1 className="text-3xl font-bold tracking-tight">
          Cze≈õƒá, {user?.name || user?.username}!
        </h1>
        <p className="text-muted-foreground mt-2">
          Mi≈Ço Ciƒô widzieƒá z powrotem. Gotowy na matematykƒô?
        </p>
      </div>

      <div className="grid gap-6 md:grid-cols-2">
        {/* LEWA KOLUMNA - LEKCJE */}
        <div className="space-y-6">
          {/* NASTƒòPNA LEKCJA (LICZNIK) */}
          <Card className="bg-primary text-primary-foreground border-none shadow-lg">
            <CardHeader>
              <CardTitle className="text-lg opacity-90">
                Nastƒôpna lekcja za
              </CardTitle>
            </CardHeader>
            <CardContent>
              {nextLesson ? (
                <div className="space-y-2">
                  <div className="text-4xl font-bold tracking-tighter">
                    {formatDistanceToNow(new Date(nextLesson.startTime), {
                      locale: pl,
                    })}
                  </div>
                  <div className="text-lg opacity-90 font-medium">
                    {format(
                      new Date(nextLesson.startTime),
                      "d MMMM yyyy, HH:mm",
                      { locale: pl }
                    )}
                  </div>
                </div>
              ) : (
                <div className="text-lg opacity-90">
                  Brak zaplanowanych lekcji.
                </div>
              )}
            </CardContent>
          </Card>

          {/* LISTA NADCHODZƒÑCYCH LEKCJI */}
          <Card>
            <CardHeader className="flex flex-row items-center justify-between">
              <CardTitle>NadchodzƒÖce lekcje</CardTitle>
              <Button variant="outline" size="sm" asChild>
                <Link href="/booking">Zarezerwuj</Link>
              </Button>
            </CardHeader>
            <CardContent>
              {myUpcomingSlots.length === 0 ? (
                <div className="text-center py-6 text-muted-foreground">
                  Brak nadchodzƒÖcych lekcji.
                  <br />
                  <Link
                    href="/booking"
                    className="text-primary hover:underline mt-2 inline-block"
                  >
                    Zarezerwuj pierwszƒÖ lekcjƒô
                  </Link>
                </div>
              ) : (
                <div className="space-y-4">
                  {myUpcomingSlots.map((slot) => (
                    <div
                      key={slot.id}
                      className="flex items-center justify-between p-4 rounded-lg border bg-card hover:bg-accent/5 transition-colors"
                    >
                      <div className="space-y-1">
                        <div className="font-semibold flex items-center gap-2">
                          <Calendar className="h-4 w-4 text-primary" />
                          {format(new Date(slot.startTime), "d MMMM yyyy", {
                            locale: pl,
                          })}
                        </div>
                        <div className="text-sm text-muted-foreground flex items-center gap-2">
                          <Clock className="h-4 w-4" />
                          {format(new Date(slot.startTime), "HH:mm")} -{" "}
                          {format(new Date(slot.endTime), "HH:mm")}
                        </div>
                        <div className="flex gap-2 mt-1">
                          <span
                            className={`text-xs px-2 py-0.5 rounded-full ${
                              slot.isPaid
                                ? "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400"
                                : "bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400"
                            }`}
                          >
                            {slot.isPaid ? "Op≈Çacone" : "Nieop≈Çacone"}
                          </span>
                        </div>
                      </div>

                      {/* PRZYCISK ANULOWANIA */}
                      <Button
                        variant="destructive"
                        size="sm"
                        className="gap-2"
                        onClick={() => {
                          if (
                            confirm("Czy na pewno chcesz anulowaƒá tƒô lekcjƒô?")
                          ) {
                            cancelSlotMutation.mutate(slot.id);
                          }
                        }}
                        disabled={cancelSlotMutation.isPending}
                      >
                        {cancelSlotMutation.isPending ? (
                          <Loader2 className="h-4 w-4 animate-spin" />
                        ) : (
                          <XCircle className="h-4 w-4" />
                        )}
                        Anuluj
                      </Button>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        </div>

        {/* PRAWA KOLUMNA - ZMIANA HAS≈ÅA */}
        <div className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Zmiana Has≈Ça</CardTitle>
            </CardHeader>
            <CardContent>
              <Form {...form}>
                <form
                  onSubmit={form.handleSubmit(onPasswordSubmit)}
                  className="space-y-4"
                >
                  {/* UKRYTE POLE NAZWY U≈ªYTKOWNIKA DLA MENED≈ªER√ìW HASE≈Å */}
                  <input
                    type="text"
                    name="username"
                    autoComplete="username"
                    value={user?.username || ""}
                    readOnly
                    style={{ display: "none" }}
                  />

                  <FormField
                    control={form.control}
                    name="currentPassword"
                    render={({ field }) => (
                      <FormItem>
                        <Label>Obecne has≈Ço</Label>
                        <FormControl>
                          <Input
                            type="password"
                            autoComplete="current-password"
                            {...field}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                  <FormField
                    control={form.control}
                    name="newPassword"
                    render={({ field }) => (
                      <FormItem>
                        <Label>Nowe has≈Ço</Label>
                        <FormControl>
                          <Input
                            type="password"
                            autoComplete="new-password"
                            {...field}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                  <Button
                    type="submit"
                    className="w-full"
                    disabled={changePasswordMutation.isPending}
                  >
                    {changePasswordMutation.isPending && (
                      <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    )}
                    Zmie≈Ñ has≈Ço
                  </Button>
                </form>
              </Form>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
}
--------------------------------
